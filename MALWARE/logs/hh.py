import os
import glob
import matplotlib.pyplot as plt
from tensorboard.backend.event_processing import event_accumulator

# -----------------------------
# 1. Find latest TensorBoard events file
# -----------------------------
log_folder = r"D:\2025 NEW PROJECTS\CODEBERT_PROJECT\MALWARE\logs"
event_files = glob.glob(os.path.join(log_folder, "events.out.tfevents.*"))
if not event_files:
    raise FileNotFoundError("No TensorBoard event files found in the logs folder.")
event_files.sort(key=os.path.getmtime)  # sort by modification time
tb_file = event_files[-1]  # pick the latest file
print("Using TensorBoard file:", tb_file)

# -----------------------------
# 2. Load TensorBoard events
# -----------------------------
ea = event_accumulator.EventAccumulator(tb_file)
ea.Reload()

# Check available tags
print("Available tags:", ea.Tags()["scalars"])

# -----------------------------
# 3. Extract metrics
# -----------------------------
# Training metrics (per step)
train_loss = ea.Scalars("train/loss")
train_steps = [x.step for x in train_loss]
train_loss_vals = [x.value for x in train_loss]

# Evaluation metrics (per evaluation, usually fewer points)
eval_loss = ea.Scalars("eval/loss")
eval_accuracy = ea.Scalars("eval/accuracy")
eval_f1 = ea.Scalars("eval/f1")

eval_steps = [x.step for x in eval_loss]  # use eval_loss steps for consistency
eval_loss_vals = [x.value for x in eval_loss]
acc_vals = [x.value for x in eval_accuracy]
f1_vals = [x.value for x in eval_f1]

# -----------------------------
# 4. Plot Training Loss
# -----------------------------
plt.figure(figsize=(8,6))
plt.plot(train_steps, train_loss_vals, label='Train Loss', color='blue')
plt.xlabel('Step')
plt.ylabel('Loss')
plt.title('CodeBERT Training - Train Loss')
plt.grid(True)
plt.legend()
plt.savefig("codebert_train_loss.png")
plt.close()

# -----------------------------
# 5. Plot Validation Loss
# -----------------------------
plt.figure(figsize=(8,6))
plt.plot(eval_steps, eval_loss_vals, label='Validation Loss', color='red', marker='o')
plt.xlabel('Step')
plt.ylabel('Loss')
plt.title('CodeBERT Training - Validation Loss')
plt.grid(True)
plt.legend()
plt.savefig("codebert_eval_loss.png")
plt.close()

# -----------------------------
# 6. Plot Validation Accuracy
# -----------------------------
plt.figure(figsize=(8,6))
plt.plot(eval_steps, acc_vals, label='Validation Accuracy', color='green', marker='o')
plt.xlabel('Step')
plt.ylabel('Accuracy')
plt.title('CodeBERT Training - Validation Accuracy')
plt.grid(True)
plt.legend()
plt.savefig("codebert_accuracy.png")
plt.close()

# -----------------------------
# 7. Plot Validation F1-score
# -----------------------------
plt.figure(figsize=(8,6))
plt.plot(eval_steps, f1_vals, label='Validation F1-score', color='purple', marker='o')
plt.xlabel('Step')
plt.ylabel('F1-score')
plt.title('CodeBERT Training - Validation F1-score')
plt.grid(True)
plt.legend()
plt.savefig("codebert_f1.png")
plt.close()

print("âœ… Graphs saved:")
print(" - codebert_train_loss.png")
print(" - codebert_eval_loss.png")
print(" - codebert_accuracy.png")
print(" - codebert_f1.png")
