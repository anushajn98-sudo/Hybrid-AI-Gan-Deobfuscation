import torch
import joblib
from transformers import RobertaTokenizer, RobertaForSequenceClassification

# -----------------------------
# 1. Load model, tokenizer, label encoder
# -----------------------------
model_path = "./malware_codebert_model"

tokenizer = RobertaTokenizer.from_pretrained(model_path)
model = RobertaForSequenceClassification.from_pretrained(model_path)
label_encoder = joblib.load(f"{model_path}/label_encoder.pkl")

device = "cuda" if torch.cuda.is_available() else "cpu"
model.to(device)
model.eval()

# -----------------------------
# 2. Prediction Function
# -----------------------------
def predict_malware_type(code_snippet: str):
    # Tokenize input
    inputs = tokenizer(code_snippet, return_tensors="pt", padding="max_length", truncation=True, max_length=256)
    inputs = {k: v.to(device) for k, v in inputs.items()}

    # Run model
    with torch.no_grad():
        outputs = model(**inputs)
        predictions = torch.argmax(outputs.logits, dim=-1).cpu().numpy()

    # Decode label
    predicted_label = label_encoder.inverse_transform(predictions)[0]
    return predicted_label

# -----------------------------
# 3. Example Usage
# -----------------------------
if __name__ == "__main__":
    while True:
        user_input = input("\nEnter obfuscated code (or type 'exit' to quit):\n")
        if user_input.lower() == "exit":
            break
        result = predict_malware_type(user_input)
        print(f"üîç Predicted Malware Type: {result}")
